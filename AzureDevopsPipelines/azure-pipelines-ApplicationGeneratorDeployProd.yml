trigger: none
resources:
  pipelines:
  - pipeline: ApplicationGeneratorBuildProd
    source: ApplicationGeneratorBuildProd
    trigger:
      branches:
        include:
        - release/*
        - hotfix/*

variables:
  workspace: "null"  
  environment: "null"
  buildConfiguration: "null"
  releaseType: "null"
  commitId: "null"  
  repositoryUri: "null"
  vmImageName: 'windows-latest'
  primaryProductBinaryName: "ApplicationGeneratore.exe"
  system.debug: true

jobs:
  - deployment: DeployProd
    displayName: 'Deploy to Prod'
    condition: and(true, succeeded()) 
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: none
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'variables'
                targetPath: '$(Pipeline.Workspace)'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'PrimaryProject'
                targetPath: '$(Pipeline.Workspace)\PrimaryProject'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'ReleaseInfo'
                targetPath: '$(Pipeline.Workspace)\ReleaseInfo'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'ReleaseAgent'
                targetPath: '$(Pipeline.Workspace)\ReleaseAgent'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'InstallerBundle'
                targetPath: '$(Pipeline.Workspace)\InstallerBundle'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'Installer'
                targetPath: '$(Pipeline.Workspace)\Installer'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'InstallerBundleWix'
                targetPath: '$(Pipeline.Workspace)\InstallerBundleWix'
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'specific'
                project: '441c02f9-baf2-486f-a70b-c4349004f95a'
                definition: '176'
                buildVersionToDownload: 'latest'
                artifactName: 'InstallerWix'
                targetPath: '$(Pipeline.Workspace)\InstallerWix'
            - task: CmdLine@2
              displayName: "List Artifacts"
              inputs:
                script: |
                  cd $(Pipeline.Workspace)
                  dir /s
            - task: oneLuckiDevJson2Variable@1
              inputs:
                jsonFile: '$(Pipeline.Workspace)\variables.json'
                shouldPrefixVariables: false
            - task: CmdLine@2
              displayName: Run release agent
              inputs:
                script: |
                  cd $(Pipeline.Workspace) 
                  .\ReleaseAgent\ReleaseAgent.exe "$(Pipeline.Workspace)" "$(primaryProductBinaryName)" "$(environment)" "$(buildConfiguration)" "$(releaseType)" "$(commitId)" "(Build.BuildUri)" "$(repositoryUri)"
