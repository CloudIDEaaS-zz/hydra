// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 16.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace AbstraX.Generators.Server.WebAPIRestServiceProvider
{
    using System.Linq;
    using System.Text;
    using System.Collections.Generic;
    using Utils;
    using AbstraX.Generators;
    using AbstraX.Angular;
    using AbstraX.DataAnnotations;
    using AbstraX;
    using System;
    
    /// <summary>
    /// Class to produce the template output
    /// </summary>
    
    #line 1 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "16.0.0.0")]
    public partial class WebAPIRestServiceProviderClassTemplate : AbstraX.Generators.Base.TemplateBase
    {
#line hidden
        /// <summary>
        /// Create the template output
        /// </summary>
        public override string TransformText()
        {
            this.Write(@"using AbstraX;
using HydraDevOps.Services.Providers;
using Microsoft.AspNetCore.Hosting;
using Newtonsoft.Json.Linq;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using Utils;
using System.Linq;
using System.Net.Http;
using System;
using ApplicationGenerator.Data.Interfaces;
using Microsoft.EntityFrameworkCore;
using HydraDevOps.Services.Models;
using ApplicationGenerator.Data;
using ");
            
            #line 34 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.RootNamespace));
            
            #line default
            #line hidden
            this.Write(".Services.Models.");
            
            #line 34 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Title));
            
            #line default
            #line hidden
            this.Write("Service;\r\nusing ApplicationGenerator.Services;\r\n\r\nnamespace ");
            
            #line 37 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.RootNamespace));
            
            #line default
            #line hidden
            this.Write(".Services.Providers.");
            
            #line 37 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Title));
            
            #line default
            #line hidden
            this.Write("Service\r\n{\r\n    public interface I");
            
            #line 39 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.ProviderName));
            
            #line default
            #line hidden
            this.Write(" : IWebApiProvider\r\n    {\r\n");
            
            #line 41 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
 
    foreach (var serviceMethod in this.ServiceMethods)
    {
        this.WriteLineSpaceIndent(8, serviceMethod.InterfaceSignature);
    }

            
            #line default
            #line hidden
            this.Write("    }\r\n\r\n    [WebApiProvider(typeof(I");
            
            #line 49 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.ProviderName));
            
            #line default
            #line hidden
            this.Write("), typeof(");
            
            #line 49 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Title));
            
            #line default
            #line hidden
            this.Write("DataContext))]\r\n    public class ");
            
            #line 50 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.ProviderName));
            
            #line default
            #line hidden
            this.Write(" : I");
            
            #line 50 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.ProviderName));
            
            #line default
            #line hidden
            this.Write(@"
    {
        private dynamic jsonConfigObject;
        private string urlBase;
        public Dictionary<string, string> ConfigVariables { get; }
        private IHandlebarsParser handlebarsParser;

        public AzureDevOpsServiceProvider(IWebHostEnvironment environment, IHandlebarsParser handlebarsParser)
        {
            var rootPath = environment.WebFrontEndRootPath;
            var configFile = Path.Combine(rootPath, ");
            
            #line 60 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.ConfigPathString));
            
            #line default
            #line hidden
            this.Write(@");

            this.ConfigVariables = new Dictionary<string, string>();
            this.handlebarsParser = handlebarsParser;

            using (var reader = new StreamReader(configFile))
            {
                this.jsonConfigObject = reader.ReadJson<object>();

                foreach (var pair in jsonConfigObject)
                {
                    this.ConfigVariables.Add(pair.Name, (string) pair.Value);
                }
            }

            urlBase = this.ConfigVariables[""urlBase""];
        }

");
            
            #line 78 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
  
    foreach (var serviceMethod in this.ServiceMethods)
    {

            
            #line default
            #line hidden
            this.Write("        ");
            
            #line 82 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(serviceMethod.MethodSignature));
            
            #line default
            #line hidden
            this.Write(" \r\n        {\r\n            var decodedId = id.FromBase64ToString();\r\n            v" +
                    "ar variables = this.GetVariables(decodedId);\r\n            var accessToken = vari" +
                    "ables[\"accessToken\"];\r\n            var authorizationKey = (\":\" + accessToken).To" +
                    "Base64();\r\n");
            
            #line 88 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
 
        foreach (var methodVariablePair in serviceMethod.MethodVariables)
        {
            this.WriteLineFormatSpaceIndent(12, "var {0} = {1};", methodVariablePair.Key, methodVariablePair.Value);
        }

            
            #line default
            #line hidden
            this.Write("\r\n            using (var client = new HttpClient())\r\n            {\r\n             " +
                    "   var resultPath = \"");
            
            #line 97 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(serviceMethod.ResultPath));
            
            #line default
            #line hidden
            this.Write(@""";  // comes from line 30 (resultPath) in json
                HttpRequestMessage request;
                JObject jObject = null;
                JArray jArray;
                string resultString;

                client.DefaultRequestHeaders.Add(""Authorization"", ""Basic "" + authorizationKey);

");
            
            #line 105 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"

        switch (serviceMethod.HttpMethod)
        {
            case "GET":

            
            #line default
            #line hidden
            this.Write(@"                request = new HttpRequestMessage(new HttpMethod(""GET""), uri);   // GET because of List ServiceMethodKind

                resultString = client.SendAsync(request).Result.Content.ReadAsStringAsync().Result;

                try
                {
                    jObject = JObject.Parse(resultString);
                }
                catch (Exception ex)
                {
                    throw new InvalidDataException(""Invalid response: \r\n"" + resultString);
                }

");
            
            #line 123 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"

                break;

            default:
                DebugUtils.Break();
                break;
        }
         
        switch (serviceMethod.ReturnType)
        {
            case "IEnumerable<dynamic>":

            
            #line default
            #line hidden
            this.Write("                jArray = (JArray) jObject.SelectToken(resultPath);\r\n\r\n           " +
                    "     foreach (var obj in jArray)\r\n                {\r\n                    var jIt" +
                    "emObject = (JObject)obj;\r\n                    var itemId = ");
            
            #line 140 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(serviceMethod.UniqueIdFactory(new string[] { "decodedId", "jItemObject[\"id\"]" })));
            
            #line default
            #line hidden
            this.Write("   // comes from line 47 (keyPattern) in json\r\n\r\n                    jObject = (J" +
                    "Object)obj;\r\n\r\n                    jObject.AddFirst(new JProperty(\"uniqueid\", it" +
                    "emId.ToBase64()));\r\n");
            
            #line 145 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"

                foreach (var returnPropertyPair in serviceMethod.ReturnProperties)
                {

            
            #line default
            #line hidden
            this.Write("                    jObject.Add(new JProperty(\"");
            
            #line 149 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(returnPropertyPair.Key));
            
            #line default
            #line hidden
            this.Write("\", ");
            
            #line 149 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(returnPropertyPair.Value));
            
            #line default
            #line hidden
            this.Write("));\r\n");
            
            #line 150 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"

                }

            
            #line default
            #line hidden
            this.Write("\r\n                    yield return jObject.ToObject<dynamic>();\r\n                " +
                    "}\r\n            }\r\n        }\r\n");
            
            #line 158 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"

                break;

            default:
                DebugUtils.Break();
                break;

        }
    }

            
            #line default
            #line hidden
            this.Write("\r\n        public IEnumerator CreateEntitySetEnumerator(DbContext context, string " +
                    "setName, string id)\r\n        {\r\n            var method = this.GetType().GetMetho" +
                    "d(\"List\" + setName);\r\n            var results = (IEnumerable) method.Invoke(this" +
                    ", new object[] { id });\r\n\r\n            return results.GetEnumerator();\r\n        " +
                    "}\r\n\r\n        public IEnumerator CreateNavigationPropertyEnumerator(DbContext con" +
                    "text, string navigationProperty, string id)\r\n        {\r\n            var method =" +
                    " this.GetType().GetMethod(\"List\" + navigationProperty);\r\n            var results" +
                    " = (IEnumerable) method.Invoke(this, new object[] { id });\r\n\r\n            return" +
                    " results.GetEnumerator();\r\n        }\r\n\r\n        public IEnumerator CreateCastEnu" +
                    "merator(DbContext context, string fromType, string toType, string id)\r\n        {" +
                    "\r\n            var method = this.GetType().GetMethod(\"Cast\" + fromType + \"To\");\r\n" +
                    "            var results = (IEnumerable) method.Invoke(this, new object[] { id, t" +
                    "oType });\r\n\r\n            return results.GetEnumerator();\r\n        }\r\n\r\n        p" +
                    "ublic dynamic CreateNavigationPropertyObject(DbContext context, string navigatio" +
                    "nProperty, string id)\r\n        {\r\n            var method = this.GetType().GetMet" +
                    "hod(\"Get\" + navigationProperty);\r\n            var dynamic = (IEnumerable) method" +
                    ".Invoke(this, new object[] { id });\r\n\r\n            return dynamic;\r\n        }\r\n\r" +
                    "\n        public string GetIdBase()\r\n        {\r\n            return this.ConfigVar" +
                    "iables[\"idBase\"];\r\n        }\r\n\r\n        public NamingConvention GetNamingConvent" +
                    "ion()\r\n        {\r\n            return NamingConvention.");
            
            #line 208 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.NamingConvention.ToString()));
            
            #line default
            #line hidden
            this.Write(";   // comes from line 5 (namingConvention) in json\r\n        }\r\n    }\r\n}");
            return this.GenerationEnvironment.ToString();
        }
        
        #line 1 "D:\MC\CloudIDEaaS\root\ApplicationGenerator.IonicAngular\Generators\Server\WebAPIRestServiceProvider\WebAPIRestServiceProviderClassTemplate.tt"

private global::System.EventHandler _DebugCallbackField;

/// <summary>
/// Access the DebugCallback parameter of the template.
/// </summary>
private global::System.EventHandler DebugCallback
{
    get
    {
        return this._DebugCallbackField;
    }
}

private string _ProviderNameField;

/// <summary>
/// Access the ProviderName parameter of the template.
/// </summary>
private string ProviderName
{
    get
    {
        return this._ProviderNameField;
    }
}

private string _TitleField;

/// <summary>
/// Access the Title parameter of the template.
/// </summary>
private string Title
{
    get
    {
        return this._TitleField;
    }
}

private string _ConfigPathStringField;

/// <summary>
/// Access the ConfigPathString parameter of the template.
/// </summary>
private string ConfigPathString
{
    get
    {
        return this._ConfigPathStringField;
    }
}

private global::ApplicationGenerator.Data.NamingConvention _NamingConventionField;

/// <summary>
/// Access the NamingConvention parameter of the template.
/// </summary>
private global::ApplicationGenerator.Data.NamingConvention NamingConvention
{
    get
    {
        return this._NamingConventionField;
    }
}

private string _RootNamespaceField;

/// <summary>
/// Access the RootNamespace parameter of the template.
/// </summary>
private string RootNamespace
{
    get
    {
        return this._RootNamespaceField;
    }
}

private global::System.Collections.Generic.List<ServiceMethod> _ServiceMethodsField;

/// <summary>
/// Access the ServiceMethods parameter of the template.
/// </summary>
private global::System.Collections.Generic.List<ServiceMethod> ServiceMethods
{
    get
    {
        return this._ServiceMethodsField;
    }
}


/// <summary>
/// Initialize the template
/// </summary>
public override void Initialize()
{
    base.Initialize();
    if ((this.Errors.HasErrors == false))
    {
bool DebugCallbackValueAcquired = false;
if (this.Session.ContainsKey("DebugCallback"))
{
    this._DebugCallbackField = ((global::System.EventHandler)(this.Session["DebugCallback"]));
    DebugCallbackValueAcquired = true;
}
if ((DebugCallbackValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("DebugCallback");
    if ((data != null))
    {
        this._DebugCallbackField = ((global::System.EventHandler)(data));
    }
}
bool ProviderNameValueAcquired = false;
if (this.Session.ContainsKey("ProviderName"))
{
    this._ProviderNameField = ((string)(this.Session["ProviderName"]));
    ProviderNameValueAcquired = true;
}
if ((ProviderNameValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("ProviderName");
    if ((data != null))
    {
        this._ProviderNameField = ((string)(data));
    }
}
bool TitleValueAcquired = false;
if (this.Session.ContainsKey("Title"))
{
    this._TitleField = ((string)(this.Session["Title"]));
    TitleValueAcquired = true;
}
if ((TitleValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("Title");
    if ((data != null))
    {
        this._TitleField = ((string)(data));
    }
}
bool ConfigPathStringValueAcquired = false;
if (this.Session.ContainsKey("ConfigPathString"))
{
    this._ConfigPathStringField = ((string)(this.Session["ConfigPathString"]));
    ConfigPathStringValueAcquired = true;
}
if ((ConfigPathStringValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("ConfigPathString");
    if ((data != null))
    {
        this._ConfigPathStringField = ((string)(data));
    }
}
bool NamingConventionValueAcquired = false;
if (this.Session.ContainsKey("NamingConvention"))
{
    this._NamingConventionField = ((global::ApplicationGenerator.Data.NamingConvention)(this.Session["NamingConvention"]));
    NamingConventionValueAcquired = true;
}
if ((NamingConventionValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("NamingConvention");
    if ((data != null))
    {
        this._NamingConventionField = ((global::ApplicationGenerator.Data.NamingConvention)(data));
    }
}
bool RootNamespaceValueAcquired = false;
if (this.Session.ContainsKey("RootNamespace"))
{
    this._RootNamespaceField = ((string)(this.Session["RootNamespace"]));
    RootNamespaceValueAcquired = true;
}
if ((RootNamespaceValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("RootNamespace");
    if ((data != null))
    {
        this._RootNamespaceField = ((string)(data));
    }
}
bool ServiceMethodsValueAcquired = false;
if (this.Session.ContainsKey("ServiceMethods"))
{
    this._ServiceMethodsField = ((global::System.Collections.Generic.List<ServiceMethod>)(this.Session["ServiceMethods"]));
    ServiceMethodsValueAcquired = true;
}
if ((ServiceMethodsValueAcquired == false))
{
    object data = global::System.Runtime.Remoting.Messaging.CallContext.LogicalGetData("ServiceMethods");
    if ((data != null))
    {
        this._ServiceMethodsField = ((global::System.Collections.Generic.List<ServiceMethod>)(data));
    }
}


    }
}


        
        #line default
        #line hidden
    }
    
    #line default
    #line hidden
}
